<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planer Zabudowy Dzia≈Çki</title>
    <link rel="stylesheet" href="style.css?v=5">
    <script>
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(() => console.log('SW registered'))
                .catch(err => console.log('SW error:', err));
        }
    </script>
</head>

<body>
    <div class="container">
        <!-- Toolbar -->
        <div class="toolbar">
            <div class="tool active" id="toolSelect" title="Zaznacz / Edytuj (V)">
                <span>‚¨ö</span>
            </div>
            <div class="tool" id="toolPan" title="Przesuwanie (H / Spacja)">
                <span>‚úã</span>
            </div>
            <div class="tool" id="toolDraw" title="Rysuj Dzia≈Çkƒô (P)">
                <span>‚úé</span>
            </div>
            <div class="tool" id="toolMeasure" title="Miarka (M) - Coming Soon">
                <span>üìè</span>
            </div>
            <div class="tool" id="toolFullscreen" title="Pe≈Çny Ekran (F)">
                <span>‚õ∂</span>
            </div>
        </div>

        <div class="sidebar">
            <h1>Planer MPZP</h1>

            <div class="panel">
                <h3>1. Mapa</h3>
                <!-- Replaced simple input with Library Trigger -->
                <button id="btnOpenLibrary" class="btn primary">üìÇ Otw√≥rz Bibliotekƒô Map</button>
                <div id="currentMapName" class="info">Brak mapy</div>
            </div>

            <div class="panel" id="calibrationPanel" style="display:none;">
                <h3>2. Kalibracja</h3>
                <p class="info">Ustaw celownik (‚úõ) nad punktem i kliknij przycisk.</p>
                <div class="controls" style="display:flex; gap:5px; flex-wrap:wrap;">
                    <button id="btnCalibPoint1" class="btn primary">üìç Punkt 1</button>
                    <button id="btnCalibPoint2" class="btn primary" disabled>üìç Punkt 2</button>
                </div>
                <div id="calibrationStatus" style="margin-top:8px; font-size:12px; color:#666;">
                    Punkty: <span id="calibPointsCount">0</span>/2
                </div>
                <div id="calibrationInput" style="display:none; margin-top: 10px;">
                    <label>Rzeczywista d≈Çugo≈õƒá (m):</label>
                    <input type="number" id="realDistance" step="0.01" value="10">
                    <button id="btnConfirmScale" class="btn success">Zatwierd≈∫ Skalƒô</button>
                </div>
                <p id="scaleDisplay">Skala: Nieustalona</p>
            </div>

            <div class="panel">
                <h3>3. Obszar Dzia≈Çki (MN)</h3>
                <p class="info">Zaznacz budowlanƒÖ (MN).</p>

                <label>Nazwa dzia≈Çki:</label>
                <input type="text" id="plotNameInput" placeholder="np. Dzia≈Çka 123/4" disabled>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:5px;">
                    <div>
                        <label>Front (m):</label>
                        <input type="number" id="setbackFrontInput" value="6">
                        <button id="btnSetFront" class="btn secondary"
                            style="width:100%; margin-top:2px; font-size:0.75rem; padding:2px;">‚ü≥ Zmie≈Ñ Front</button>
                    </div>
                    <div>
                        <label>Boki (m):</label>
                        <input type="number" id="setbackSideInput" value="4">
                    </div>
                </div>

                <div style="margin-top:5px;">
                    <label>Max Szer. Elewacji (m):</label>
                    <input type="number" id="maxFrontageInput" value="16">
                </div>

                <div style="margin-top:10px;">
                    <button id="btnDrawPlot" class="btn primary">‚úé Rysuj (tap)</button>
                    <button id="btnAddPlotPoint" class="btn primary">üìç Dodaj Punkt</button>
                    <button id="btnFinishPlot" class="btn success" disabled>‚úì Zako≈Ñcz</button>
                </div>
                <div style="margin-top:5px;">
                    <button id="btnClearPlot" class="btn danger">Usu≈Ñ ZaznaczonƒÖ</button>
                </div>

                <div class="stats" style="margin-top:10px;">
                    <div>Powierzchnia: <span id="areaDisplay">-</span> m¬≤</div>
                </div>
                <label style="margin-top:5px; display:block;"><input type="checkbox" id="chkShowPlot" checked disabled>
                    Poka≈º dzia≈Çkƒô</label>
            </div>

            <div class="panel">
                <h3>4. Budynki</h3>
                <p class="info">Dodaj i przeciƒÖgnij.</p>

                <label>Typ:</label>
                <select id="bType" style="width:100%; padding:5px;">
                    <option value="house">Mieszkalny (MN)</option>
                    <option value="garage">Gara≈º/Gosp (G)</option>
                    <option value="driveway">Podjazd/Utwardz.</option>
                </select>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:5px;">
                    <div>
                        <label>Szer (m):</label>
                        <input type="number" id="bWidth" value="10">
                    </div>
                    <div>
                        <label>D≈Ç (m):</label>
                        <input type="number" id="bLength" value="14">
                    </div>
                </div>

                <div id="houseParams" style="margin-top:5px;">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                        <div>
                            <label>Kondyg.:</label>
                            <select id="bFloors">
                                <option value="1">1</option>
                                <option value="1.5">1.5 (Poddasze)</option>
                                <option value="2">2</option>
                            </select>
                        </div>
                        <div>
                            <label>Dach (¬∞):</label>
                            <input type="number" id="bRoof" value="30" min="0" max="90">
                        </div>
                    </div>
                    <div style="margin-top:5px;">
                        <label>Wysoko≈õƒá (m):</label>
                        <input type="number" id="bHeight" value="8.5">
                    </div>
                </div>

                <div style="margin-top:10px; display:flex; gap:5px;">
                    <button id="btnAddBuilding" class="btn primary" style="flex:1">Dodaj</button>
                </div>
                <p class="info">Klawisze: 'R' - obr√≥t, 'Delete' - usu≈Ñ.</p>
            </div>

            <div class="panel" id="balancePanel">
                <h3>5. Bilans Terenu (Live)</h3>
                <table style="width:100%; font-size:0.9rem;">
                    <tr>
                        <td>Intensywno≈õƒá (FAR):</td>
                        <td id="valFAR" style="text-align:right; font-weight:bold;">-</td>
                    </tr>
                    <tr>
                        <td style="font-size:0.8rem; color:#666;">Norma: 0.1 - 0.5</td>
                        <td id="statusFAR" style="text-align:right;"></td>
                    </tr>

                    <tr>
                        <td>Bio-czynna (%):</td>
                        <td id="valGreen" style="text-align:right; font-weight:bold;">-</td>
                    </tr>
                    <tr>
                        <td style="font-size:0.8rem; color:#666;">Min: 50%</td>
                        <td id="statusGreen" style="text-align:right;"></td>
                    </tr>

                    <tr>
                        <td>Miejsca Postojowe:</td>
                        <td id="valParking" style="text-align:right; font-weight:bold;">-</td>
                    </tr>
                    <tr>
                        <td style="font-size:0.8rem; color:#666;">Min: 2</td>
                        <td id="statusParking" style="text-align:right;"></td>
                    </tr>
                </table>
            </div>

            <div class="panel">
                <h3>Eksport</h3>
                <button id="btnSave" class="btn success">Zapisz Obraz</button>

                <div class="panel" style="margin-top: auto; border: 1px solid #ccc; background: #fffbe6;">
                    <h3>Skr√≥ty i Pomoc</h3>
                    <ul style="padding-left: 20px; margin: 5px 0; font-size: 0.85rem; color: #444;">
                        <li><b>K√≥≈Çko myszy</b>: Przybli≈ºanie / Oddalanie</li>
                        <li><b>≈öPM (K√≥≈Çko) / SPACJA + Mysz</b>: Przesuwanie mapy (Pan)</li>
                        <li><b>LPM na dzia≈Çkƒô</b>: Zaznacz do edycji (przeciƒÖgnij rogi)</li>
                        <li><b>LPM na budynek</b>: Zaznacz / Przesu≈Ñ</li>
                        <li><b>Delete</b>: Usu≈Ñ zaznaczony element</li>
                        <li><b>R (lub Strza≈Çki)</b>: Obr√≥t budynku</li>
                    </ul>
                </div>
            </div>
        </div>
        <!-- SIDEBAR ENDS HERE -->

        <!-- MAIN CONTENT AREA (Canvas) - MUST BE SIBLING OF SIDEBAR -->
        <div class="main-content">
            <canvas id="planCanvas"></canvas>
        </div>
    </div>
    <!-- Library Modal -->
    <div id="libraryModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div
            style="background:white; width:900px; height:600px; border-radius:8px; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 0 20px rgba(0,0,0,0.5);">
            <div
                style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; background:#f0f0f0;">
                <div>
                    <button id="tabMaps" class="btn primary">Biblioteka Map</button>
                    <button id="tabProjects" class="btn secondary">Biblioteka Projekt√≥w</button>
                </div>
                <button id="btnCloseLibrary"
                    style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>

            <!-- MAPS VIEW -->
            <div id="viewMaps" style="flex:1; display:flex; overflow:hidden;">
                <div id="libList"
                    style="flex:2; overflow-y:auto; padding:10px; border-right:1px solid #eee; display:grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); grid-gap:10px; align-content:start;">
                </div>
                <div
                    style="flex:1; padding:15px; background:#f9f9f9; display:flex; flex-direction:column; gap:10px; overflow-y:auto;">
                    <h3>Wgraj NowƒÖ Mapƒô</h3>
                    <input type="file" id="serverFileInput" accept="image/*">
                    <input type="text" id="uploadDesc" placeholder="Opis (opcjonalnie)" style="width:100%">
                    <button id="btnServerUpload" class="btn success">Wy≈õlij na Serwer</button>
                    <hr>
                    <div id="selectedImageDetails" style="display:none; flex-direction:column; gap:10px;">
                        <h3>Wybrana Mapa</h3>
                        <div id="selImgName" style="font-weight:bold; word-break:break-all;"></div>
                        <img id="selImgPreview"
                            style="max-width:100%; max-height:150px; object-fit:contain; border:1px solid #ddd;">
                        <textarea id="selImgDesc" rows="3" placeholder="Opis..."></textarea>
                        <button id="btnUpdateDesc" class="btn secondary">Zapisz Opis</button>
                        <button id="btnLoadMap" class="btn primary">Za≈Çaduj do Projektu</button>
                        <button id="btnDeleteMap" class="btn danger">Usu≈Ñ z Serwera</button>
                    </div>
                </div>
            </div>

            <!-- PROJECTS VIEW -->
            <div id="viewProjects" style="flex:1; display:none; overflow:hidden;">
                <div id="projList"
                    style="flex:2; overflow-y:auto; padding:10px; border-right:1px solid #eee; display:flex; flex-direction:column; gap:5px;">
                </div>
                <div
                    style="flex:1; padding:15px; background:#f9f9f9; display:flex; flex-direction:column; gap:10px; overflow-y:auto;">
                    <h3>Zapisz do Chmury</h3>
                    <p class="info">Zapisuje obecny stan (dzia≈Çki, mapa) na serwerze.</p>
                    <input type="text" id="saveProjDesc" placeholder="Opis projektu..." style="width:100%">
                    <button id="btnServerSaveProj" class="btn success">Zapisz Projekt</button>
                    <hr>
                    <div id="selectedProjDetails" style="display:none; flex-direction:column; gap:10px;">
                        <h3>Wybrany Projekt</h3>
                        <div id="selProjName" style="font-weight:bold;"></div>
                        <div id="selProjDate" style="color:#666; font-size:0.8rem;"></div>
                        <div id="selProjDescDisplay"
                            style="font-style:italic; padding:5px; background:#fff; border:1px solid #ddd;"></div>
                        <button id="btnLoadProj" class="btn primary">Wczytaj Projekt</button>
                        <button id="btnDeleteProj" class="btn danger">Usu≈Ñ Projekt</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Modal Dialog -->
    <div id="customModal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <h3 id="modalTitle">Potwierd≈∫</h3>
            <p id="modalMessage">Czy na pewno chcesz wykonaƒá tƒô akcjƒô?</p>
            <div class="modal-buttons">
                <button id="modalCancel" class="btn">Anuluj</button>
                <button id="modalConfirm" class="btn danger">Potwierd≈∫</button>
            </div>
        </div>
    </div>

    <script src="app.js?v=10"></script>
</body>

</html>